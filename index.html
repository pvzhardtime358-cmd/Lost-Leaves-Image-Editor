<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LOST LEAVES IMAGE EDITOR</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>

    <link rel="stylesheet" href="text.css">

    <style>
        :root { --accent: #00ffcc; --bg: #0a0a0a; --panel: rgba(25, 25, 25, 0.98); --border: #444; }
        
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: var(--bg); color: white; font-family: 'Segoe UI', Tahoma, sans-serif;
            overflow: hidden; touch-action: none;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 10px; }
        ::-webkit-scrollbar-track { background: #111; }

        #rotate-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; display: none;
            flex-direction: column; align-items: center; justify-content: center;
        }
        @media screen and (orientation: portrait) { #rotate-overlay { display: flex; } }

        #canvas-wrapper { width: 100vw; height: 100vh; background: #050505; position: relative; transition: background 0.3s; overflow: hidden; }

        .animated { background-size: 400% 400% !important; animation: moveBG 8s ease infinite; }
        @keyframes moveBG {
            0%   { background-position: 0% 50%; }
            50%  { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .panel {
            position: absolute; background: var(--panel); 
            border: 1px solid var(--border); border-radius: 12px; 
            padding: 12px; z-index: 100; display: flex; box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            overflow-y: auto;
        }

        .tools { top: 10px; bottom: 10px; left: 10px; flex-direction: column; width: 65px; gap: 10px; }
        .props { top: 10px; right: 10px; width: 220px; flex-direction: column; gap: 15px; bottom: 10px; }
        
        .colors { 
            top: 10px; left: 85px; right: 240px; height: auto;
            flex-direction: column; gap: 8px; align-items: flex-start;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-height: 180px; overflow: hidden;
        }
        .colors.collapsed {
            width: 60px; height: 60px; right: auto; padding: 5px; cursor: pointer;
            border-color: var(--accent);
        }
        .colors.collapsed #pal, .colors.collapsed #harmony-row, .colors.collapsed .label {
            display: none !important;
        }

        #color-rows { display: flex; align-items: center; gap: 10px; overflow-x: auto; width: 100%; padding-bottom: 8px; }
        #harmony-row { display: flex; gap: 8px; align-items: center; border-top: 1px solid #333; padding-top: 5px; width: 100%; overflow-x: auto; }

        #bg-lib-overlay, #import-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95);
            z-index: 1000; display: none; flex-direction: column; padding: 40px;
        }
        #bg-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px; overflow-y: auto; padding-right: 10px;
        }
        .bg-tile { height: 100px; border-radius: 12px; cursor: pointer; border: 2px solid #333; transition: 0.2s; }
        .bg-tile:hover { transform: scale(1.05); border-color: var(--accent); }
        .close-lib { align-self: flex-end; font-size: 35px; color: var(--accent); cursor: pointer; margin-bottom: 20px; font-weight: bold; }
        
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            z-index: 2000; display: none; align-items: center; justify-content: center;
        }
        .modal-content {
            background: #1a1a1a; padding: 30px; border-radius: 15px; border: 1px solid var(--accent);
            width: 320px; text-align: center;
        }
        .modal-content input[type="number"], select {
            width: 100%; padding: 10px; margin: 10px 0; background: #222; border: 1px solid #444; color: white; border-radius: 5px; text-align: center;
        }

        .btn { min-height: 50px; width: 50px; background: #222; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 22px; border: 1px solid var(--border); cursor: pointer; transition: 0.2s; flex-shrink: 0; }
        .btn:hover { border-color: var(--accent); }
        .btn.active { border-color: var(--accent); background: #1a3a35; }
        .swatch { min-width: 42px; height: 42px; border-radius: 50%; cursor: pointer; border: 2px solid #555; flex-shrink: 0; transition: 0.2s; }
        .swatch.harmony { min-width: 32px; height: 32px; border: 1px solid #777; }
        .save-btn { background: var(--accent); color: #000; font-weight: bold; border: none; padding: 15px; border-radius: 10px; cursor: pointer; width: 100%; }
        .secondary-btn { background: #333; color: white; border: 1px solid #555; padding: 12px; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 10px; }
        .del-btn { background: #3d1010; color: #ff6b6b; border: 1px solid #632121; padding: 10px; border-radius: 8px; width: 100%; margin-top: 10px; cursor: pointer; }
        .label { font-size: 10px; text-transform: uppercase; color: var(--accent); font-weight: bold; margin-bottom: 2px; display: block; }
        
        .nav-tool { background: #111; color: var(--accent); border: 1px dashed var(--accent); margin-top: 5px; }

        #palette-trigger { font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; height: 50px; width: 50px; flex-shrink: 0;}
    </style>
</head>
<body>

<div id="rotate-overlay">
    <h1 style="color: var(--accent)"><i class="fas fa-sync-alt"></i> ROTATE TO LANDSCAPE</h1>
    <p>The studio needs more width to work correctly.</p>
</div>

<div id="bg-lib-overlay">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px;">
        <h2 style="margin:0; color:var(--accent);">Background Library (<span id="bg-count">0</span> styles)</h2>
        <div class="close-lib" onclick="toggleBG()">×</div>
    </div>
    <div id="bg-grid"></div>
</div>

<div id="import-overlay" class="modal">
    <div class="modal-content">
        <h3 style="color:var(--accent); margin-top:0;">Image Import Type</h3>
        <p style="font-size: 13px; color: #bbb;">How should we handle this image?</p>
        <button class="save-btn" onclick="processImport('simple')">SIMPLE LAYER</button>
        <p style="font-size: 11px; color: #777; margin: 5px 0 15px;">Standard sticker style.</p>
        <button class="save-btn" style="background: #0088ff; color: white;" onclick="processImport('tint')">COLOR TINT LAYER</button>
        <p style="font-size: 11px; color: #777; margin: 5px 0;">Paint will only stick to the image, not the background.</p>
        <button class="secondary-btn" onclick="closeImport()">CANCEL</button>
    </div>
</div>

<div id="export-modal" class="modal">
    <div class="modal-content">
        <h3 style="color:var(--accent); margin-top:0;">Export Art</h3>
        <label class="label">Width (px)</label>
        <input type="number" id="exp-w" value="1920">
        <label class="label">Height (px)</label>
        <input type="number" id="exp-h" value="1080">
        
        <div style="display: flex; align-items: center; gap: 10px; margin: 10px 0; justify-content: center; background: #222; padding: 10px; border-radius: 8px;">
            <input type="checkbox" id="exp-transparent" style="width: 20px; height: 20px; cursor: pointer;">
            <label for="exp-transparent" class="label" style="margin:0; cursor: pointer;">Transparent Background</label>
        </div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="save-btn" onclick="finalizeSave()">DOWNLOAD</button>
            <button class="del-btn" style="margin:0;" onclick="closeModal()">CANCEL</button>
        </div>
    </div>
</div>

<div id="canvas-wrapper"><canvas id="c"></canvas></div>

<div class="panel tools">
    <div class="btn active" id="m-select" onclick="mode('select')"><i class="fas fa-mouse-pointer"></i></div>
    <div class="btn" id="m-brush" onclick="mode('brush')"><i class="fas fa-paint-brush"></i></div>
    <div class="btn" id="m-eraser" onclick="mode('eraser')"><i class="fas fa-eraser"></i></div>
    <div class="btn" onclick="addText()"><b>T</b></div>
    <div class="btn" onclick="toggleBG()"><i class="fas fa-images"></i></div>
    <label class="btn"><i class="fas fa-upload"></i><input type="file" id="up" hidden></label>
    <div style="height:1px; background:#444; width:100%;"></div>
    <div class="btn" onclick="addShape('sun')"><i class="fas fa-sun"></i></div>
    <div class="btn" onclick="addShape('moon')"><i class="fas fa-moon"></i></div>
    <div class="btn" onclick="addShape('star')"><i class="fas fa-star"></i></div>
    <div class="btn" onclick="addShape('rect')"><i class="far fa-square"></i></div>
    <div class="btn" onclick="addShape('circle')"><i class="far fa-circle"></i></div>
    <div style="height:1px; background:#444; width:100%;"></div>
    <div class="btn nav-tool" onclick="panCanvas(0, -150)"><i class="fas fa-arrow-up"></i></div>
    <div class="btn nav-tool" onclick="panCanvas(0, 150)"><i class="fas fa-arrow-down"></i></div>
</div>

<div class="panel props">
    <div>
        <span class="label">Brush Size</span>
        <input type="range" id="size" min="1" max="400" value="20" oninput="updateBrush()">
    </div>
    <div>
        <span class="label">Layer Opacity</span>
        <input type="range" id="opacity" min="1" max="100" value="100" oninput="updateOpacity()">
    </div>

    <div style="border: 1px solid #444; padding: 8px; border-radius: 8px; background: rgba(0,0,0,0.3);">
        <span class="label" style="color:#00ffcc;">Remove Image BG</span>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
            <button class="secondary-btn" style="margin-top:5px; padding: 5px; font-size: 10px;" onclick="removeLayerBG('#ffffff')">WHITE</button>
            <button class="secondary-btn" style="margin-top:5px; padding: 5px; font-size: 10px;" onclick="removeLayerBG('#000000')">BLACK</button>
        </div>
        <p style="font-size: 9px; color: #777; margin: 5px 0 0;">Select image layer first</p>
    </div>
    
    <div>
        <span class="label">Drawing Layer Type</span>
        <select id="blend-mode" onchange="updateBlendMode()">
            <option value="color">colour textures</option>
            <option value="source-atop">colour all</option>
            <option value="source-over">Normal Layer</option>
            <option value="multiply">Multiply (Darken)</option>
            <option value="screen">Screen (Lighten)</option>
            <option value="overlay">Overlay</option>
        </select>
    </div>

    <div style="border-top: 1px solid #333; padding-top: 10px;">
        <button class="save-btn" onclick="openSaveModal()">SAVE IMAGE</button>
        <button class="secondary-btn" style="background:#004433; margin-bottom:5px;" onclick="bringToFront()">BRING TO TOP</button>
        <button class="secondary-btn" style="background:#222; margin-bottom:5px;" onclick="sendToBack()">PUSH TO BOTTOM</button>
        <button class="del-btn" onclick="del()">DELETE SELECTED</button>
        <button class="del-btn" style="background:#222; color:#aaa;" onclick="canvas.clear();">CLEAR ALL</button>
    </div>
</div>

<div class="panel colors collapsed" id="color-panel" onclick="expandColors(event)">
    <div id="color-rows">
        <div id="palette-trigger"><i class="fas fa-palette"></i></div>
        <input type="color" id="picker" value="#00ffcc" style="width:55px; height:55px; border:none; background:none; cursor:pointer;" oninput="updateBrush(); calculateHarmony();">
        <div id="pal" style="display:flex; gap:10px;"></div>
    </div>
    <div id="harmony-row">
        <span class="label" style="margin-right:10px;">Harmonies:</span>
        <div id="harmonies" style="display:flex; gap:8px;"></div>
    </div>
</div>

<script>
    const canvas = new fabric.Canvas('c', { width: window.innerWidth, height: window.innerHeight, preserveObjectStacking: true });
    let currentMode = 'select';
    let pendingImage = null;
    // Variables to hold the true dimensions of the uploaded image
    let originalImgWidth = 1920; 
    let originalImgHeight = 1080;

    function expandColors(e) {
        const panel = document.getElementById('color-panel');
        if(panel.classList.contains('collapsed')) {
            panel.classList.remove('collapsed');
        } else if (e.target.id === 'palette-trigger' || e.target.parentElement.id === 'palette-trigger') {
            panel.classList.add('collapsed');
        }
    }

    function mode(m) {
        currentMode = m;
        document.querySelectorAll('.tools .btn').forEach(b => b.classList.remove('active'));
        if(document.getElementById('m-'+m)) document.getElementById('m-'+m).classList.add('active');
        canvas.isDrawingMode = (m === 'brush' || m === 'eraser');
        if (canvas.isDrawingMode) updateBrush();
    }

    function panCanvas(x, y) {
        const delta = new fabric.Point(x, y);
        canvas.relativePan(delta);
    }

    function updateBrush() {
        if (!canvas.isDrawingMode) return;
        canvas.off('path:created'); 
        canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
        canvas.freeDrawingBrush.width = parseInt(document.getElementById('size').value);
        canvas.freeDrawingBrush.strokeLineCap = 'round';
        
        if (currentMode === 'eraser') {
            canvas.on('path:created', function(opt) { 
                if(currentMode==='eraser'){ opt.path.globalCompositeOperation='destination-out'; canvas.renderAll(); } 
            });
        } else {
            canvas.freeDrawingBrush.color = document.getElementById('picker').value;
            const blend = document.getElementById('blend-mode').value;
            canvas.on('path:created', function(opt) { 
                if(currentMode==='brush') {
                    const path = opt.path;
                    path.globalCompositeOperation = blend;

                    if (blend === 'color') {
                        const target = canvas.getObjects().slice().reverse().find(o => o.type === 'image');
                        if (target) {
                            path.clipPath = target;
                            path.clipPath.absolutePositioned = true;
                        }
                    }
                    canvas.renderAll();
                }
            });
        }
    }

    function updateBlendMode() {
        const active = canvas.getActiveObject();
        const mode = document.getElementById('blend-mode').value;
        if(active) { active.set('globalCompositeOperation', mode); canvas.renderAll(); }
        if(canvas.isDrawingMode) updateBrush();
    }

    function updateOpacity() {
        const active = canvas.getActiveObject();
        if(active) { active.set('opacity', document.getElementById('opacity').value / 100); canvas.renderAll(); }
    }

    function removeLayerBG(hex) {
        const active = canvas.getActiveObject();
        if(!active || active.type !== 'image') {
            alert("Select an uploaded image layer first.");
            return;
        }
        
        const filter = new fabric.Image.filters.RemoveColor({
            color: hex,
            distance: 0.12 
        });
        
        active.filters.push(filter);
        active.applyFilters();
        canvas.renderAll();
    }

    function hexToHsl(hex) {
        let r = parseInt(hex.slice(1,3), 16) / 255, g = parseInt(hex.slice(3,5), 16) / 255, b = parseInt(hex.slice(5,7), 16) / 255;
        let max = Math.max(r, g, b), min = Math.min(r, g, b), h, s, l = (max + min) / 2;
        if(max == min) h = s = 0;
        else {
            let d = max - min; s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
            switch(max) { case r: h = (g - b) / d + (g < b ? 6 : 0); break; case g: h = (b - r) / d + 2; break; case b: h = (r - g) / d + 4; break; }
            h /= 6;
        }
        return [h * 360, s * 100, l * 100];
    }

    function hslToHex(h, s, l) {
        l /= 100; const a = s * Math.min(l, 1 - l) / 100;
        const f = n => {
            const k = (n + h / 30) % 12; const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
            return Math.round(255 * color).toString(16).padStart(2, '0');
        };
        return `#${f(0)}${f(8)}${f(4)}`;
    }

    function calculateHarmony() {
        const hex = document.getElementById('picker').value;
        const [h, s, l] = hexToHsl(hex);
        const container = document.getElementById('harmonies');
        container.innerHTML = '';
        const hues = [(h+180)%360, (h+30)%360, (h-30+360)%360, (h+120)%360, (h+240)%360];
        hues.forEach(newH => {
            const hexResult = hslToHex(newH, s, l);
            const d = document.createElement('div');
            d.className = 'swatch harmony'; d.style.background = hexResult;
            d.onclick = () => { document.getElementById('picker').value = hexResult; updateBrush(); calculateHarmony(); };
            container.appendChild(d);
        });
    }

    function initBGLibrary() {
        const grid = document.getElementById('bg-grid');
        const styles = [];
        const basics = ['#ff0000','#ffffff','#000000','#0000ff','#00ff00','#ffff00','#ff00ff','#00ffff','#808080'];
        basics.forEach(c => styles.push({s: c, a: false}));
        for(let h=0; h<360; h+=2) styles.push({s:`hsl(${h}, 100%, 50%)`, a:false});
        for(let h=0; h<360; h+=2) styles.push({s:`linear-gradient(180deg, hsl(${h}, 100%, 40%), hsl(${(h+40)%360}, 100%, 20%))`, a:false});
        for(let i=0; i<300; i++) {
            let h1 = Math.random()*360, h2 = (h1+60)%360;
            styles.push({s:`linear-gradient(45deg, hsl(${h1}, 100%, 40%) 0%, hsl(${h2}, 100%, 30%) 100%)`, a:false});
        }
        for(let h=0; h<360; h+=1.8) styles.push({s:`linear-gradient(90deg, #000, hsl(${h}, 100%, 50%), #000)`, a: true});
        document.getElementById('bg-count').innerText = styles.length;
        styles.forEach(bg => {
            const d = document.createElement('div'); d.className = 'bg-tile' + (bg.a ? ' animated' : ''); d.style.background = bg.s;
            d.onclick = () => {
                const wrapper = document.getElementById('canvas-wrapper'); wrapper.style.background = bg.s;
                bg.a ? wrapper.classList.add('animated') : wrapper.classList.remove('animated');
                toggleBG();
            };
            grid.appendChild(d);
        });
    }

    function initColors() {
        const pal = document.getElementById('pal');
        for(let i=0; i<=100; i+=2) createSwatch(hslToHex(0, 0, i));
        for(let h=0; h<360; h+=0.5) createSwatch(hslToHex(h, 100, 50));
    }

    function createSwatch(c) {
        let d = document.createElement('div'); d.className = 'swatch'; d.style.background = c;
        d.onclick = (e) => { e.stopPropagation(); document.getElementById('picker').value = c; updateBrush(); calculateHarmony(); };
        document.getElementById('pal').appendChild(d);
    }

    function sendToBack() {
        const active = canvas.getActiveObject();
        if(active) { active.sendToBack(); canvas.discardActiveObject().renderAll(); }
    }
    
    function bringToFront() {
        const active = canvas.getActiveObject();
        if(active) { active.bringToFront(); canvas.discardActiveObject().renderAll(); }
    }

    document.getElementById('up').onchange = (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const r = new FileReader();
        r.onload = (f) => { pendingImage = f.target.result; document.getElementById('import-overlay').style.display = 'flex'; };
        r.readAsDataURL(file);
    };

    // MODIFIED: Captures original dimensions but scales image to fit screen for editing
    function processImport(type) {
        fabric.Image.fromURL(pendingImage, img => {
            // 1. Store original dimensions for later export
            originalImgWidth = img.width;
            originalImgHeight = img.height;

            // 2. Update the export modal inputs so they default to the correct high-res size
            document.getElementById('exp-w').value = originalImgWidth;
            document.getElementById('exp-h').value = originalImgHeight;

            // 3. Scale the image visually to fit nicely on the current screen canvas
            const scaleFactor = (canvas.width * 0.8) / img.width;
            img.scale(scaleFactor);
            
            canvas.add(img);
            canvas.centerObject(img);
            
            document.getElementById('blend-mode').value = (type === 'tint') ? 'color' : 'source-over';
            if(type === 'tint') mode('brush');
            closeImport();
        }, { crossOrigin: 'anonymous' });
    }

    function closeImport() { document.getElementById('import-overlay').style.display = 'none'; pendingImage = null; }
    function toggleBG() { const o = document.getElementById('bg-lib-overlay'); o.style.display = o.style.display === 'flex' ? 'none' : 'flex'; }
    function openSaveModal() { document.getElementById('export-modal').style.display = 'flex'; }
    function closeModal() { document.getElementById('export-modal').style.display = 'none'; }

    // MODIFIED: Uses a multiplier to export at high resolution regardless of screen size
    async function finalizeSave() {
        // Get intended dimensions from inputs (which default to original image size)
        const intendedW = parseInt(document.getElementById('exp-w').value);
        const intendedH = parseInt(document.getElementById('exp-h').value);
        const isTransparent = document.getElementById('exp-transparent').checked;
        
        // Calculate how much bigger the output needs to be compared to the current screen canvas
        const multiplier = intendedW / canvas.width;

        const dataURL = canvas.toDataURL({ 
            format: 'png', 
            multiplier: multiplier, 
            enableRetinaScaling: false 
        });

        const exportCanvas = document.createElement('canvas'); 
        exportCanvas.width = intendedW; 
        exportCanvas.height = intendedH;
        const ctx = exportCanvas.getContext('2d');

        if(!isTransparent) {
            const wrapper = document.getElementById('canvas-wrapper');
            const bgStyle = window.getComputedStyle(wrapper);
            ctx.fillStyle = bgStyle.backgroundColor || "#050505"; 
            ctx.fillRect(0, 0, intendedW, intendedH);
        }

        const img = new Image();
        img.onload = () => { 
            // Draw the high-res result onto the export canvas
            ctx.drawImage(img, 0, 0, intendedW, intendedH); 
            const link = document.createElement('a'); 
            link.download = `Art_${Date.now()}.png`; 
            link.href = exportCanvas.toDataURL('image/png'); 
            link.click(); 
            closeModal(); 
        };
        img.src = dataURL;
    }

    function addText() { 
        const text = new fabric.IText('Double Tap', { left: canvas.width / 2 - 100, top: canvas.height / 2, fill: document.getElementById('picker').value, fontSize: 40 });
        canvas.add(text);
    }

    function addShape(t) {
        let o; const color = document.getElementById('picker').value;
        if(t==='sun') o = new fabric.Circle({radius:50, fill:'#ffd700', shadow: {color:'#ffcc00', blur:30}});
        if(t==='moon') o = new fabric.Path('M 50 0 A 50 50 0 1 0 50 100 A 40 40 0 1 1 50 0 Z', {fill:'#eee', scaleX:1.5, scaleY:1.5});
        if(t==='star') o = new fabric.Polygon([{x:10,y:0},{x:13,y:7},{x:20,y:7},{x:15,y:12},{x:17,y:20},{x:10,y:15},{x:3,y:20},{x:5,y:12},{x:0,y:7},{x:7,y:7}], {fill:'#fff', scaleX:4, scaleY:4});
        if(t==='rect') o = new fabric.Rect({width:100, height:100, fill:color});
        if(t==='circle') o = new fabric.Circle({radius:50, fill:color});
        canvas.add(o); canvas.centerObject(o);
    }
    
    function del() { canvas.remove(...canvas.getActiveObjects()); canvas.discardActiveObject().renderAll(); }
    
    // Restored original resize behavior to fix background patterns
    window.onresize = () => { canvas.setDimensions({ width: window.innerWidth, height: window.innerHeight }); }
    
    initBGLibrary();
    initColors();
    calculateHarmony();
</script>
</body>
</html>